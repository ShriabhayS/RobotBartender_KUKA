<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Robotic Bartender</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <!-- <link rel="stylesheet" href="../static/style.css"> -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
</head>
<body>
    <div class="wrap">
        <center>
            <div class="pt-3 heading">
                ☇&nbsp;&nbsp; Robotic &nbsp;&nbsp;☇
                <div class="big">Bartender</div>
            </div>
        </center>
        <div class="btn-wrap">
            <button onclick="selectAction(this, 1)">
                <div class="img-area">
                    <img src="{{ url_for('static', filename='holstenpomegranate.png') }}" alt="holstenpomegranate">
                </div>
                <div class="drink-info">
                    <div class="drink-title">Holsten Pomegranate</div>
                    <div class="tag">Non-Alcoholic</div>
                    <div class="drink-desc">Pomegranate beer, fruity and bold</div>
                </div>
            </button>
            <button onclick="selectAction(this, 4)">
                <div class="img-area">
                    <img src="{{ url_for('static', filename='holstenmojito.png') }}" alt="holstenmojito">
                </div>
                <div class="drink-info">
                    <div class="drink-title">Holsten Mojito</div>
                    <div class="tag">Non-Alcoholic</div>
                    <div class="drink-desc">Mojito beer, minty and refreshing</div>
                </div>
            </button>
            <button onclick="selectAction(this, 2)">
                <div class="img-area">
                    <img src="{{ url_for('static', filename='carltondry.png') }}" alt="carltondry">
                </div>
                <div class="drink-info">
                    <div class="drink-title">Carlton Dry</div>
                    <div class="tag">Alcoholic</div>
                    <div class="drink-desc">Crisp lager, light and refreshing</div>
                </div>
            </button>
            <button onclick="selectAction(this, 3)">
                <div class="img-area">
                    <img src="{{ url_for('static', filename='somersby.png') }}" alt="somersby">
                </div>
                <div class="drink-info">
                    <div class="drink-title">Somersby</div>
                    <div class="tag">Alcoholic</div>
                    <div class="drink-desc">Apple cider, sweet and crisp</div>
                </div>
            </button>
            <!-- <button onclick="selectAction(this, 3)">
                <div class="img-area">
                    <img src="{{ url_for('static', filename='cocacola.png') }}" alt="cocacola">
                </div>
                <div class="drink-info">
                    <div class="drink-title">Coca-Cola</div>
                    <div class="drink-desc">Iconic cola, sweet and fizzy</div>
                </div>
            </button>
            <button onclick="selectAction(this, 2)">
                <div class="img-area">
                    <img src="{{ url_for('static', filename='schweppes.png') }}" alt="schweppes">
                </div>
                <div class="drink-info">
                    <div class="drink-title">Schweppes</div>
                    <div class="drink-desc">Premium tonic, crisp and refreshing</div>
                </div>
            </button>
            <button onclick="selectAction(this, 1)">
                <div class="img-area">
                    <img src="{{ url_for('static', filename='bundaberg.png') }}" alt="bundaberg" style="height: 400px;">
                </div>
                <div class="drink-info">
                    <div class="drink-title">Bundaberg</div>
                    <div class="drink-desc">Classic ginger beer, rich & spicy</div>
                </div>
            </button>
            <button onclick="selectAction(this, 7)">
                <div class="img-area">
                    <img src="{{ url_for('static', filename='solo.png') }}" alt="solo">
                </div>
                <div class="drink-info">
                    <div class="drink-title">Solo</div>
                    <div class="drink-desc">Lemon drink, tangy and refreshing</div>
                </div>
            </button>
            <button onclick="selectAction(this, 4)">
                <div class="img-area">
                    <img src="{{ url_for('static', filename='sanpellegrino.png') }}" alt="sanpellegrino">
                </div>
                <div class="drink-info">
                    <div class="drink-title">San Pellegrino</div>
                    <div class="drink-desc">Italian sparkling mineral water</div>
                </div>
            </button>
            <button onclick="selectAction(this, 5)">
                <div class="img-area">
                    <img src="{{ url_for('static', filename='fevertree.png') }}" alt="fevertree">
                </div>
                <div class="drink-info">
                    <div class="drink-title">Fever-Tree</div>
                    <div class="drink-desc">Natural mixers, aromatic and light</div>
                </div>
            </button> -->
        </div>
        </div>
    </div>

    <!-- Hidden input to store selected action before confirming in modal -->
    <input type="hidden" id="selectedAction" name="selectedAction" value="">

    <div class="modal fade modal-fullscreen" tabindex="-1" id="bottleModal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-left">
                    <a class="btn btn-link text-light p-0 text-left" style="position: absolute; width: 100px; left: 30px; top: 50px;" data-bs-dismiss="modal">← Back</a>
                    <div class="modal-confirm-text mt-3">
                        <h2 id="modalBottleTitle">Confirm selection</h2>
                        <p id="modalBottleDesc" class="text-muted">Would you like your bottle opened?</p>
                    </div>

                    <div class="confirm-actions mt-4">
                        <button type="button" id="openOn" class="toggle-btn secondary text-center" onclick="setOpenBottle(true)">Open Bottle</button>
                        <button type="button" id="openOff" class="toggle-btn secondary text-center" onclick="setOpenBottle(false)">Keep Sealed</button>
                        <button type="button" id="modalSaveBtn" class="btn btn-primary mt-4" onclick="showConfirmOverlay()">Place Order</button>
                    </div>
                </div>

                <div class="modal-right">
                    <div class="modal-bottle-preview">
                        <img id="modalBottleImg" src="" alt="bottle" />
                    </div>
                </div>

                <!-- Confirm overlay inside modal -->
                <div class="confirm-overlay" id="confirmOverlay">
                    <div class="confirm-box">
                        <h5>Confirm Order</h5>
                        <p class="small text-muted">Are you sure you want to place this order?</p>
                        <div class="d-flex gap-3 justify-content-center mt-3">
                            <button class="btn btn-secondary" onclick="hideConfirmOverlay()">Cancel</button>
                            <button class="btn btn-primary" onclick="confirmAction()">Yes, place order</button>
                        </div>
                    </div>
                </div>

                <!-- hidden checkbox used by existing code to persist open choice -->
                <input type="checkbox" id="openBottle" name="openBottle" style="display:none;" />
            </div>
        </div>
    </div>


    <script>
        // robotFunc sends the order. If bottleOpen is provided, uses that; otherwise reads checkbox.
        function robotFunc(actionNumber, bottleOpen) {
            const bottleVal = (typeof bottleOpen !== 'undefined') ? (bottleOpen ? 1 : 0) : (document.getElementById('openBottle').checked ? 1 : 0);
            fetch(`/sendOrder/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    actionNumber: actionNumber,
                    bottleOpen: bottleVal
                })
            });
        }
    </script>

    <script>
        function selectAction(clickedBtn, actionNumber) {
            document.getElementById('selectedAction').value = actionNumber;

            // Extract the image, title, and description from the clicked button
            const imgEl = clickedBtn.querySelector('.img-area img');
            const titleEl = clickedBtn.querySelector('.drink-title');
            const descEl = clickedBtn.querySelector('.drink-desc');

            const modalImg = document.getElementById('modalBottleImg');
            const modalTitle = document.getElementById('modalBottleTitle');
            const modalDesc = document.getElementById('modalBottleDesc');

            if (imgEl && modalImg) {
                // prefer the original attribute so we don't get an empty value from computed src in some environments
                const src = imgEl.getAttribute('src') || imgEl.src;
                modalImg.src = src;
            }
            if (titleEl && modalTitle) modalTitle.textContent = titleEl.textContent;
            if (descEl && modalDesc) modalDesc.textContent = descEl.textContent;

            // Reset open bottle choice (no selection) and visual toggles
            const cb = document.getElementById('openBottle');
            if (cb) cb.checked = false;
            window.openBottleChoice = undefined;
            document.getElementById('openOn').classList.remove('toggle-active');
            document.getElementById('openOff').classList.remove('toggle-active');
            // Enable Place Order only after a choice is made; default allow pressing (you can change behavior)
            const saveBtn = document.getElementById('modalSaveBtn');
            if (saveBtn) saveBtn.disabled = false;

            // Show the Bootstrap modal
            const modalEl = document.getElementById('bottleModal');
            const modal = new bootstrap.Modal(modalEl);
            modal.show();
        }

        // Called when the modal Save changes button is clicked. Reads the stored action and calls robotFunc.
        function confirmAction() {
            const action = parseInt(document.getElementById('selectedAction').value, 10);
            if (!action) {
                // nothing selected
                return;
            }

            // Use the chosen openBottleChoice (must be true/false) — if somehow unset, default to false
            const bottleChoice = (typeof window.openBottleChoice !== 'undefined') ? !!window.openBottleChoice : false;

            // Call robotFunc with explicit bottleOpen
            robotFunc(action, bottleChoice);

            // Hide the modal
            const modalEl = document.getElementById('bottleModal');
            const modal = bootstrap.Modal.getInstance(modalEl);
            if (modal) modal.hide();
        }

        function showConfirmOverlay() {
            const overlay = document.getElementById('confirmOverlay');
            if (overlay) overlay.classList.add('active');
        }

        function hideConfirmOverlay() {
            const overlay = document.getElementById('confirmOverlay');
            if (overlay) overlay.classList.remove('active');
        }
    </script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js" integrity="sha512-q/dWJ3kcmjBLU4Qc47E4A9kTB4m3wuTY7vkFJDTZKjTs8jhyGQnaUrxa0Ytd0ssMZhbNua9hE+E7Qv1j+DyZwA==" crossorigin="anonymous"></script>
    <script type="text/javascript" charset="utf-8">
        var socket = io();
        socket.on('connect', function() {
            socket.emit('my event', {data: 'I\'m connected!'});
        });
    </script>

    <!-- Tilt behavior for horizontal scroller images -->
    <script src="{{ url_for('static', filename='tilt.js') }}"></script>

    <script>
        function setOpenBottle(state) {
            const cb = document.getElementById('openBottle');
            const onBtn = document.getElementById('openOn');
            const offBtn = document.getElementById('openOff');
            cb.checked = state;
            // document.getElementById('openBottleLabel').textContent = `Open bottle? (${state ? 'Yes' : 'No'})`;

            // Toggle visual active state
            if (state) {
                onBtn.classList.add('toggle-active');
                onBtn.setAttribute('aria-pressed', 'true');
                offBtn.classList.remove('toggle-active');
                offBtn.setAttribute('aria-pressed', 'false');
            } else {
                offBtn.classList.add('toggle-active');
                offBtn.setAttribute('aria-pressed', 'true');
                onBtn.classList.remove('toggle-active');
                onBtn.setAttribute('aria-pressed', 'false');
            }

            // Store explicit choice and enable the Place Order button
            window.openBottleChoice = !!state;
            const saveBtn = document.getElementById('modalSaveBtn');
            if (saveBtn) saveBtn.disabled = false;
        }

        // Initialize toggle state on page load based on checkbox (default unchecked)
        document.addEventListener('DOMContentLoaded', function () {
            const initialState = document.getElementById('openBottle').checked;
            setOpenBottle(initialState);
        });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI" crossorigin="anonymous"></script>
</body>
</html>
